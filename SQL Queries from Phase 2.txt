SQL Queries


select
  l.neighbourhood, r."Avg_Rent", d.month, co."safety_score"
from
  "Fact" f
  join (
    select
      "locationId",
      neighbourhood
    from
      "Location"
    where
      neighbourhood = 'Sandy Hill - Ottawa East'
  ) l on f."locationId" = l."locationId"
  join (
    select
      *
    from
      "Date"
    where
      month = 2
  ) d on f."date" = d."Date"
  join (
    select
      SUM(co."severityLevel") / count(co."incidentDate") as Safety_Score,
      co."locationId"
    from
      "Criminal_Offences_Final" co
    where
      co."locationId" in (
        select
          "locationId"
        from
          "Location"
        where
          neighbourhood = 'Sandy Hill - Ottawa East'
      )
      and extract(
        month
        from
          co."incidentDate"
      ) = 2
    group by
      co."locationId"
  ) co on f."locationId" = co."locationId"
  join (
    select
      "neighbourhood",
      SUM("rent") / COUNT(r."rentalId") as "Avg_Rent"
    from
      "Rental" r
    where
      r."neighbourhood" = 'Sandy Hill - Ottawa East'
    group by
      neighbourhood
  ) r on l."neighbourhood" = r."neighbourhood"
  limit 1;

Select
  l.neighbourhood, f."Avg_Rent", d.month, f."SafetyScore"
from
  "Fact" f
join
  "Location" l on f."locationId" = l."locationId"
join
  "Date" d on f."date" = d."Date"
--where "Avg_Rent" != null
--Group by l.neighbourhood, f."Avg_Rent", d.month, f."SafetyScore"

Select "Location"."locationId", "Date"."Date" from
"Date" cross join "Location";

Select DISTINCT(neighbourhood) from "Location";

Select distinct "incidentDate" from "Criminal_Offences_Final"

ALTER TABLE "Date"
ADD COLUMN month INTEGER;


UPDATE "Date"
SET month = EXTRACT(MONTH FROM "Date");

UPDATE "Rental"
SET "neighbourhoodId" = "Location"."locationId"
FROM "Location" WHERE "Rental"."neighbourhood" = "Location"."neighbourhood";

UPDATE "Fact"
SET "SafetyScore" = (
    SELECT SUM(co."severityLevel") / COUNT(co."incidentDate")
    FROM "Criminal_Offences_Final" co
    WHERE EXTRACT(month FROM co."incidentDate") = EXTRACT(month FROM "Fact".date)
    AND co."locationId" = "Fact"."locationId"
    GROUP BY co."locationId"
);

set statement_timeout to 600000;

UPDATE "Fact"
SET "severitySum" = (
    SELECT SUM(co."severityLevel"), co."locationId"
    FROM "Criminal_Offences_Final" co, "Fact"
    WHERE EXTRACT(month FROM co."incidentDate") = EXTRACT(month FROM "Fact".date)
    AND co."locationId" = "Fact"."locationId"
    GROUP BY co."locationId"
);


UPDATE "Fact" f
SET "severitySum" = temp.sum
from temp
where f."locationId" = temp."locationId"
    
UPDATE "Fact"
SET "incidentCount" = (
    SELECT COUNT(co."incidentDate"), co."locationId"
    FROM "Criminal_Offences_Final" co, "Fact"
    WHERE EXTRACT(month FROM co."incidentDate") = EXTRACT(month FROM "Fact".date)
    AND co."locationId" = "Fact"."locationId"
    GROUP BY co."locationId"
);

UPDATE "Fact" f
SET "SafetyScore" = "severitySum"/"incidentCount"
--Added columns to avoid joins as setting values for 300000 rows timed out

UPDATE "Fact"
SET "Avg_Rent" = (
    SELECT SUM("Rental".rent)/ COUNT("Rental"."rentalId")
    FROM "Rental"
    WHERE 
    "Fact"."locationId" = "Rental"."neighbourhoodId"
    GROUP BY "Rental"."neighbourhoodId"
);